<!DOCTYPE html>
<html>
<head>
    <title>客户编辑</title>
    <meta charset="UTF-8"/>
    <link href="../../resources/biz/css/pop.css" rel="stylesheet" type="text/css"/>
    <link href="../../resources/js/easyui1.9.4/themes/metro/easyui.css" rel="stylesheet"/>
    <link href="../../resources/js/easyui1.9.4/themes/icon.css" rel="stylesheet" type="text/css" />
    <script src="../../resources/js/easyui1.9.4/jquery.min.js" type="text/javascript"></script>
    <script src="../../resources/js/easyui1.9.4/jquery.easyui.min.js" type="text/javascript"></script>
    <script src="../../resources/js/easyui1.9.4/locale/easyui-lang-zh_CN.js" type="text/javascript"></script>
    <link href="../../resources/js/bootstrap/css/bootstrap.css" rel="stylesheet"/>
    <script src="../../resources/js/bootstrap/js/bootstrap.min.js"></script>
    
	<script src="../../resources/js/dataform.js" type="text/javascript"></script>
</head>
<body class="page-space" >
<div class="container-fluid">
    <div class="row">
        <div class="col-xs-12 toolbar" id="topnav">
            <button id="btnSave" class="easyui-linkbutton" iconCls="icon-save">保存</button>
            <button class="easyui-linkbutton" iconcls="icon-back" onclick="window.history.back()">返回</button>
        </div>
    </div>
    
	<div class="group-title" style="margin-left: 0%;margin-top:5px;margin-bottom: 5px">基本信息</div>

    <div class="row  p-top5">
        <div class="col-xs-1">
            <div class="lbl-text tip-red">统一社会信用代码</div>
        </div>
        <div class="col-xs-3">
            <input id="CUSTOMER_NO" name="CUSTOMER_NO" class="easyui-textbox"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
        <div class="col-xs-1">
            <div class="lbl-text tip-red">客户名称</div>
        </div>
        <div class="col-xs-3">
            <input id="CUSTOMER_NAME" name="CUSTOMER_NAME" class="easyui-textbox"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
        <div class="col-xs-1">
            <div class="lbl-text tip-red">客户类型</div>
        </div>
        <div class="col-xs-3">
            <input id="STATUS" name="STATUS" class="easyui-combobox"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
    </div>
    <!-- <div class="row  p-top5">
    	<div class="col-xs-1">
            <div class="lbl-text tip-blue">审核状态</div>
        </div>
        <div class="col-xs-3">
            <input id="STATUS" name="STATUS" disabled="disabled" class="easyui-combobox"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
        <div class="col-xs-1">
            <div class="lbl-text tip-blue">审核人</div>
        </div>
        <div class="col-xs-3">
            <input id="APPROVAL_USER" name="APPROVAL_USER" class="easyui-textbox" disabled="disabled"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
        <div class="col-xs-1">
            <div class="lbl-text tip-blue">审核时间</div>
        </div>
        <div class="col-xs-3">
            <input id="APPROVALDATE" name="APPROVALDATE" class="easyui-datetimebox" disabled="disabled"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
    </div> -->
    
    <div class="group-title" style="margin-left: 0%;margin-top:5px;margin-bottom: 5px">联系人信息</div>
    
    <div class="row  p-top5">
    	<div class="col-xs-1">
            <div class="lbl-text tip-red">联系人</div>
        </div>
        <div class="col-xs-3">
            <input id="PERSON" name="PERSON" class="easyui-textbox"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
    	<div class="col-xs-1">
            <div class="lbl-text tip-red">联系人职位</div>
        </div>
        <div class="col-xs-3">
            <input id="POSITION" name="POSITION" class="easyui-textbox"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
        <div class="col-xs-1">
            <div class="lbl-text tip-red">电话</div>
        </div>
        <div class="col-xs-3">
            <input id="TEL" name="TEL" class="easyui-textbox"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
    </div>
    
    <div class="row  p-top5">
        <div class="col-xs-1">
            <div class="lbl-text tip-red">邮箱</div>
        </div>
        <div class="col-xs-3">
            <input id="MAIL" name="MAIL" class="easyui-textbox"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
        <div class="col-xs-1">
            <div class="lbl-text tip-red">创建人</div>
        </div>
        <div class="col-xs-3">
            <input id="CREATED_BY_NAME" name="CREATED_BY_NAME" class="easyui-textbox" disabled="disabled"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
        <div class="col-xs-1">
            <div class="lbl-text tip-red">创建时间</div>
        </div>
        <div class="col-xs-3">
            <input id="CREATE_TIME" name="CREATE_TIME" class="easyui-datetimebox" disabled="disabled"
                   style="height:30px;line-height:30px; width:100%"/>
        </div>
    </div>
    <div class="row  p-top5">
        <div class="col-xs-1">
            <div class="lbl-text tip-blue">公司地址</div>
        </div>
        <div class="col-xs-11">
            <input id="COMPANY_ADDRESS" name="COMPANY_ADDRESS" class="easyui-textbox"
                   data-options="multiline:true" style="height:70px; width:100%"/>
        </div>
    </div>
    
    
    
    <input id="txt_INDX" name="txt_INDX" type="hidden"/>
</div>
</body>
</html>
<script type="text/javascript">
$(function () {
	$("#STATUS").combobox({method: 'get',url: '../../flow/GetCustomerComboboxFroSelect2',valueField: 'CODE_VALUE',textField: 'TEXT'});
    $("#CREATED_BY_NAME").combobox({method: 'get',url: '../../user/GetUserCombobox',valueField: "INDX",textField: 'USER_REAL_NAME'});
    
    var indx = GetRequestName("ValueId");
    if (indx.length > 0) {
        $.ajax({
            url: '../../ent/GetEntByIndx?INDX=' + indx,
            dataType: 'json',
            success: function (rows) {
                if (rows.length != 0) {
                    $('#CUSTOMER_NO').textbox('setValue', rows.T_CUSTOMER[0].CUSTOMER_NO);
                    $('#CUSTOMER_NAME').textbox('setValue', rows.T_CUSTOMER[0].CUSTOMER_NAME);
                    $('#STATUS').combobox('setValue', rows.T_CUSTOMER[0].STATUS);
                    $('#TEL').textbox('setValue', rows.T_CUSTOMER[0].TEL);
                    $('#MAIL').textbox('setValue', rows.T_CUSTOMER[0].MAIL);
                    $('#PERSON').textbox('setValue', rows.T_CUSTOMER[0].PERSON);
                    $('#POSITION').textbox('setValue', rows.T_CUSTOMER[0].POSITION);
                    $('#COMPANY_NAME').textbox('setValue', (rows.T_CUSTOMER[0].COMPANY_NAME));
                    $('#COMPANY_ADDRESS').textbox('setValue', (rows.T_CUSTOMER[0].COMPANY_ADDRESS));
                    $('#CREATED_BY_NAME').textbox('setValue', (rows.T_CUSTOMER[0].CREATED_BY_NAME));
                    $('#CREATE_TIME').datebox('setValue', (rows.T_CUSTOMER[0].CREATE_TIME));
                    $('#APPROVAL_USER').textbox('setValue', (rows.T_CUSTOMER[0].APPROVAL_USER));
                    $('#APPROVALDATE').datebox('setValue', (rows.T_CUSTOMER[0].APPROVALDATE));
                    
                    document.getElementById('txt_INDX').value = rows.T_CUSTOMER[0].INDX;
                    parent.LoadingHide();
                }
            }
        });
    } else {
        $.ajax({
            url: '../../auth/GetUserInfo',
            type: "POST",
            dataType: "json",
            success: function (result) {
                $('#CREATED_BY_NAME').textbox('setValue', result.username);//创建人
            }
        });
        $('#CREATE_TIME').datetimebox('setValue', getNowFormatDate());
        $('#STATUS').combobox('setValue', '1-广告主');
    }
    
    var p_type = GetRequestName("p_type");
    if (p_type.length > 0) {
    	$.ajax({
            url: '../../auth/GetUserInfo',
            type: "POST",
            dataType: "json",
            success: function (result) {
            	if("0" == result.usertype){//种业公司
            		$("#STATUS").combobox({method: 'get',url: '../../flow/GetCustomerComboboxFroSelect3',valueField: 'CODE_VALUE',textField: 'TEXT'});
            	}else if("1" == result.usertype){//经销商
            		$('#STATUS').combobox('setValue', '3-经销商');
                	$('#STATUS').combobox('disable');
            	}
            }
        });
    }
});

$("#btnSave").click(function () {
    if (vali()) {
        parent.LoadingShow();
        var arr = new Array();
        PUSH(arr, "INDX", $("#txt_INDX").val());
        PUSH(arr, "CUSTOMER_NO", $("#CUSTOMER_NO").val());
        PUSH(arr, "CUSTOMER_NAME", $("#CUSTOMER_NAME").val());
        PUSH(arr, "STATUS", $("#STATUS").combobox("getText"));
        PUSH(arr, "TEL", $("#TEL").val());
        PUSH(arr, "MAIL", $("#MAIL").val());
        PUSH(arr, "POSITION", $("#POSITION").val());
        PUSH(arr, "COMPANY_NAME", $("#COMPANY_NAME").val());
        PUSH(arr, "COMPANY_ADDRESS", $("#COMPANY_ADDRESS").val());
        PUSH(arr, "CREATED_BY_NAME", $("#CREATED_BY_NAME").val());
        PUSH(arr, "CREATE_TIME", $("#CREATE_TIME").datebox("getValue"));
        PUSH(arr, "PERSON", $("#PERSON").val());
        /* PUSH(arr, "DESC1", $("#DESC1").val());
        PUSH(arr, "DESC2", $("#DESC2").val());
        PUSH(arr, "DESC3", $("#DESC3").val());
        PUSH(arr, "DESC4", $("#DESC4").val());
        PUSH(arr, "DESC5", $("#DESC5").val());
        PUSH(arr, "DESC6", $("#DESC6").val());
        PUSH(arr, "DESC7", $("#DESC7").val());
        PUSH(arr, "DESC8", $("#DESC8").val());
        PUSH(arr, "DESC9", $("#DESC9").val());
        PUSH(arr, "DESC10", $("#DESC10").val());
        PUSH(arr, "DESC11", $("#DESC11").val());
        PUSH(arr, "DESC12", $("#DESC12").val()); */
        // var CHANCE_DESC = escape($("#txt_CHANCE_DESC").textbox('getText'));

        var json = eval('({' + arr.join(",") + '})');
        $.ajax({
            url: "../../ent/SaveEnt?TYPE=SAVE",
            type: "POST",
            datatype: "json",
            data: json,
            success: function (result) {
                var resultobj = eval("(" + result + ")");
                if (resultobj.IsOk == '1') {
                	if(resultobj.CUSTOMER_NO != ''){
                		$("#CUSTOMER_NO").textbox('setValue',resultobj.CUSTOMER_NO);
                	}
                	document.getElementById('txt_INDX').value = resultobj.ReturnData;
                    //window.parent.DgReload("商业机会","dg");
                    parent.$.messager.alert("消息!", resultobj.ErrMessage);
                    // parent.document.getElementById('iframeHright').contentWindow.location.reload(true);
                    parent.document.getElementById('iframeHright').contentWindow.$('#dg').datagrid('reload');
                    //parent.$('#Pop_Ship').window('close');
                    parent.LoadingHide();
                } else {
                    $.messager.alert("警告！", resultobj.ErrMessage);
                    parent.LoadingHide();
                }
            }
        });
    }
});

function getNowFormatDate() {
    var date = new Date();
    var seperator1 = "-";
    var seperator2 = ":";
    var month = date.getMonth() + 1;
    var strDate = date.getDate();
    if (month >= 1 && month <= 9) {
        month = "0" + month;
    }
    if (strDate >= 0 && strDate <= 9) {
        strDate = "0" + strDate;
    }
    var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate
        + " " + date.getHours() + seperator2 + date.getMinutes()
        + seperator2 + date.getSeconds();
    return currentdate;
}

function formatterDateStart(date) {
    var day = date.getDate() > 9 ? date.getDate() : "0" + date.getDate();
    var month = (date.getMonth() + 1) > 9 ? (date.getMonth() + 1) : "0" + (date.getMonth() + 1);
    var hor = "09";
    var min = "00";
    var sec = "00";
    return date.getFullYear() + '-' + month + '-' + day + " " + hor + ":" + min + ":" + sec;
};

function vali() {
	var customerNo = $('#CUSTOMER_NO').val();
	if (customerNo == null || customerNo == "") {
        $.messager.alert("警告!", "统一社会信用代码不能为空");
        return false;
    }else {
        if (customerNo.length != 18) {
            $.messager.alert("警告!", "统一社会信用代码为18位，目前已输入"+customerNo.length+"位！");
            parent.LoadingHide();
            return false;
        }
    }
	
    if ($('#CUSTOMER_NAME').val() == null || $('#CUSTOMER_NAME').val() == "") {
        $.messager.alert("警告!", "客户名称不能为空");
        return false;
    }
    if ($("#STATUS").combobox('getValue') == null || $("#STATUS").combobox('getValue') == "") {
        $.messager.alert("警告!", "客户类型不能为空");
        return false;
    }
    if ($("#CREATED_BY_NAME").combobox('getValue') == null || $("#CREATED_BY_NAME").combobox('getValue') == "") {
        $.messager.alert("警告!", "创建人不能为空");
        return false;
    }
    if ($('#CREATE_TIME').datebox('getValue') == null || $('#CREATE_TIME').datebox('getValue') == "") {
        $.messager.alert("警告!", "创建时间不能为空");
        return false;
    }
    
    if ($('#PERSON').val() == null || $('#PERSON').val() == "") {
        $.messager.alert("警告!", "联系人不能为空");
        return false;
    }
    if ($('#POSITION').val() == null || $('#POSITION').val() == "") {
        $.messager.alert("警告!", "联系人职位不能为空");
        return false;
    }
    //只能包含数字和-的电话号码验证
    if ($('#TEL').val() == null || $('#TEL').val() == "") {
        $.messager.alert("警告!", "联系电话不能为空");
        return false;
    } else {
        var reTell = /^[+]{0,1}(\d){1,3}[ ]?([-]?((\d)|[ ]){1,12})+$/;
        if (!reTell.test($("#TEL").val())) {
            $.messager.alert("警告!", "请输入正确的手机号，例如：18601230123");
            parent.LoadingHide();
            return false;
        }
    }
    if ($('#MAIL').val() == null || $('#MAIL').val() == "") {
    	$.messager.alert("警告!", "邮箱不能为空");
        return false;
    }else {
    	var reTell = /^[\.a-zA-Z0-9_-]+@[\.a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/;
        if (!reTell.test($("#MAIL").val())) {
            $.messager.alert("警告!", "请输入正确的邮箱账号，例如：tianjin@qq.com");
            parent.LoadingHide();
            return false;
        }
    }
    return true;
}

function PUSH(arr, key, val) {
    if ($.trim(val) == "" || val == null) {
        arr.push(key + ":" + "''");
    } else {
        arr.push(key + ":'" + val + "'");
    }
}

</script>